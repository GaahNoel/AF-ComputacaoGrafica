<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <title>Babylon.js sample code</title>

    <!-- Babylon.js -->
    <script src="https://code.jquery.com/pep/0.4.2/pep.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.2/dat.gui.min.js"></script>
    <script src="https://preview.babylonjs.com/ammo.js"></script>
    <script src="https://preview.babylonjs.com/cannon.js"></script>
    <script src="https://preview.babylonjs.com/Oimo.js"></script>
    <script src="https://preview.babylonjs.com/libktx.js"></script>
    <script src="https://preview.babylonjs.com/earcut.min.js"></script>
    <script src="https://preview.babylonjs.com/babylon.js"></script>
    <script src="https://preview.babylonjs.com/inspector/babylon.inspector.bundle.js"></script>
    <script src="https://preview.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
    <script src="https://preview.babylonjs.com/proceduralTexturesLibrary/babylonjs.proceduralTextures.min.js"></script>
    <script src="https://preview.babylonjs.com/postProcessesLibrary/babylonjs.postProcess.min.js"></script>
    <script src="https://preview.babylonjs.com/loaders/babylonjs.loaders.js"></script>
    <script src="https://preview.babylonjs.com/serializers/babylonjs.serializers.min.js"></script>
    <script src="https://preview.babylonjs.com/gui/babylon.gui.min.js"></script>

    <style>
        html,
        body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #renderCanvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }
    </style>
</head>

<body>
    <canvas id="renderCanvas"></canvas>
    <script>
        var canvas = document.getElementById("renderCanvas");

        var engine = null;
        var scene = null;
        var createDefaultEngine = function () { return new BABYLON.Engine(canvas, true, { preserveDrawingBuffer: true, stencil: true }); };
        var selecionado = false;
        var zoom = 0;
        var meshCarro;
        var help = false;
        var menuHelp;
        var advancedTexture;
        var selectedCar = 1;
        var points=0;
        var idSelectedCar;
        var inGame = false;

        var createScene = function () {

            // Create the scene space
            var scene = new BABYLON.Scene(engine);

            // Add a camera to the scene and attach it to the canvas
            /*var camera = new BABYLON.ArcRotateCamera("Camera", 0, 0, 0, BABYLON.Vector3.Zero(), scene);
            camera.setPosition(new BABYLON.Vector3(50, 0, 0));
            camera.attachControl(canvas, true);

            // Add lights to the scene
            var light1 = new BABYLON.HemisphericLight("light1", new BABYLON.Vector3(1, 1, 0), scene);
            var light2 = new BABYLON.PointLight("light2", new BABYLON.Vector3(0, 1, -1), scene);*/

            var map = {};
            scene.actionManager = new BABYLON.ActionManager(scene);

            scene.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnKeyDownTrigger, function (evt) {
                map[evt.sourceEvent.key] = evt.sourceEvent.type == "keydown";

            }));

            scene.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnKeyUpTrigger, function (evt) {
                map[evt.sourceEvent.key] = evt.sourceEvent.type == "keydown";
            }));
            scene.registerAfterRender(function (scene) {

                if(map['h']|| map['H']){
                    if(!help){
                        menuHelp.dispose();
                        cleanMesh(scene);
                        if(advancedTexture)
                            advancedTexture.dispose();
                        //menuEscolha(scene);
                        menuHelp = criarHubHelp();
                        selecionado = false;
                        points = 0;
                        help = true;
                        inGame=false;
                        var pontos = scene.getMeshesByID("point");
                        var smoke = scene.getMeshByID("foutain");
                        var bg = scene.getMeshByID("bg");
                        if(pontos && smoke){
                            smoke.dispose();
                            pontos.forEach(function (mesh){
                                mesh.dispose();
                            })
                        }
                        if(bg)
                            bg.dispose();
                        scene.clearColor = new BABYLON.Color3(0,0,0);
                    }
                }

                if(map['j']|| map['J']){
                    if(help){
                        menuHelp.dispose();
                        const menuT = menuEscolha(scene);
                        const fumaca = scene.getMeshesByID("foutain");
                        fumaca.forEach(function(mesh){
                            mesh.dispose();
                        })
                        escolhaConfirmarCarro(menuT, scene);
                        help = false;
                    }
                }

               
                });

                const menuText = menuEscolha(scene);
                
                escolhaConfirmarCarro(menuText, scene);

            return scene;
        }

        function setupInitialScene(scene){
            scene.cameras.forEach(function(camera){
                camera.dispose(false,true)
            })

            var camera = new BABYLON.ArcRotateCamera("Camera", 0, 0, 0, BABYLON.Vector3.Zero(), scene);
            camera.setPosition(new BABYLON.Vector3(40, 15, 0));
            camera.lockedTarget = new BABYLON.Vector3(0,5,20);

            var light2 = new BABYLON.PointLight("light2", new BABYLON.Vector3(5, 5, 20), scene);

            var background =  BABYLON.MeshBuilder.CreatePlane("bg", {height:125, width: 125, sideOrientation: BABYLON.Mesh.DOUBLESIDE}, scene);
            background.position = new BABYLON.Vector3(-10,10,15);
            background.rotation.y = 4.75;
            var materialBg = new BABYLON.StandardMaterial("material", scene);
            materialBg.diffuseTexture = new BABYLON.Texture("./Sky.jpg");
            materialBg.diffuseTexture.uScale = 0.4;
            materialBg.diffuseTexture.vScale = 1.5;
            materialBg.specularTexture = new BABYLON.Texture("./Sky.jpg");
            materialBg.emissiveTexture = new BABYLON.Texture("./Sky.jpg");
            background.material = materialBg;
            
        }

        function menuEscolha(scene){
            
            setupInitialScene(scene);

            var carro1 = criarCarro(1);
            var carro2 = criarCarro(2);
            var carro3 = criarCarro(3);
            var carro4 = criarCarro(4);
            var carro5 = criarCarro(5);
            carro2.position.z = 10;
            carro3.position.z = 20;
            carro4.position.z = 30;
            carro5.position.z = 40;

            

            menuHelp = criarHubMenuEscolha();
            //var risco = BABYLON.MeshBuilder.CreateBox("point", { height: 3, width: 3, size: 6 }, scene);
            //risco.position.y = 4;
            return  menuHelp;
        }


        function criarCarro(idCarro) {

            meshCarro = new BABYLON.Mesh("carro", scene);

            var hitbox = BABYLON.MeshBuilder.CreateBox(String(idCarro), { height: 3.1   , width: 3.9, size: 6.6 }, scene);
            hitbox.visibility = 0;
            hitbox.position.y = 0.5;

            var materialCarroPrincipal = materialCarro(idCarro);
            var materialCarroParachoque = materialCarro("parachoque");

            let deslY = -0.4;
            let deslX = 1.40;
            let deslZ = 1.75;

            var caixaCorpoInferiorCarro = BABYLON.MeshBuilder.CreateBox("caixaI", { height: 0.4, width: 3, size: 6.5 }, scene);
            var caixaCorpoMediaCarro = BABYLON.MeshBuilder.CreateBox("caixaM", { height: 0.6, width: 2.95, size: 6.4 }, scene);
            var caixaCorpoSuperiorCarro = BABYLON.MeshBuilder.CreateBox("caixaS", { height: 1.4, width: 2.9, size: 4.5 }, scene);
            

            //RODA
            var wheelMaterial = new BABYLON.StandardMaterial("wheel_mat", scene);
            //var wheelTexture = new BABYLON.Texture("http://i.imgur.com/ZUWbT6L.png", scene);
            var wheelTexture = new BABYLON.Texture("Wheels.png", scene);
            wheelMaterial.diffuseTexture = wheelTexture;
            
            var faceColors=[];
            faceColors[1] = new BABYLON.Color3(0,0,0);
            
            var faceUV =[];
            faceUV[0] = new BABYLON.Vector4(0,0,1,1);
            faceUV[2] = new BABYLON.Vector4(0,0,1,1);
        
            var wheelFI = BABYLON.MeshBuilder.CreateCylinder("wheelFI", {diameter: 1.2, height: 1, tessellation: 24, faceColors:faceColors, faceUV:faceUV}, scene);
            wheelFI.material = wheelMaterial;
             
            wheelFI.rotate(BABYLON.Axis.Z, Math.PI/2, BABYLON.Space.WORLD);


            var pivotFI = new BABYLON.Mesh("pivotFI", scene);
            pivotFI.parent = caixaCorpoMediaCarro;
            pivotFI.position = new BABYLON.Vector3(-1.1, -0.5, 2);
            
            var pivotFO = new BABYLON.Mesh("pivotFO", scene);
            pivotFO.parent = caixaCorpoMediaCarro;
            pivotFO.position = new BABYLON.Vector3(1.1, -0.5, 2);

            var wheelFO = wheelFI.createInstance("FO");
            wheelFO.parent = pivotFO;
            
            var wheelRI = wheelFI.createInstance("RI");
            wheelRI.parent = caixaCorpoMediaCarro;
            wheelRI.position = new BABYLON.Vector3(-1.1, -0.5, -2);
            
            var wheelRO = wheelFI.createInstance("RO");
            wheelRO.parent = caixaCorpoMediaCarro;
            wheelRO.position = new BABYLON.Vector3(1.1, -0.5, -2);
            
            wheelFI.parent = pivotFI;


            pivot = new BABYLON.Mesh("pivot", scene); //current centre of rotation
            pivot.position.z = 50;
            caixaCorpoMediaCarro.parent = pivot;
            //var wheelFI = BABYLON.MeshBuilder.CreateCylinder("wheelFI", {diameter: 3, height: 1, tessellation: 24}, scene);
            //pivot.addChild(wheelFI);
            caixaCorpoMediaCarro.position = new BABYLON.Vector3(0,0,-50);

            //var teste = BABYLON.MeshBuilder.CreateBox("caixaS", { height: 1.4, width: 2.9, size: 4.5 }, scene);
            //teste.position = pivot.position;
            
            //caixaCorpoInferiorCarro.parent = caixaCorpoMediaCarro;
            //caixaCorpoSuperiorCarro.parent = caixaCorpoMediaCarro;

            //#region Aplicando material 
            caixaCorpoInferiorCarro.material = materialCarroParachoque;
            caixaCorpoMediaCarro.material = materialCarroPrincipal;
            caixaCorpoSuperiorCarro.material = materialCarroPrincipal;
            //#endregion

            //#region Altera posições das partes do carro
            caixaCorpoMediaCarro.position.y = 0.4;
            caixaCorpoSuperiorCarro.position.y = 1;
            //#endregion

            //#region Definindo posições das rodas
            //wheelFO.position.y = deslY;
            //wheelFO.position.x = deslX;
            //wheelFO.position.z = deslZ;
            wheelFO.rotation.x = 0.5;

            //wheelFI.position.y = deslY;
            //wheelFI.position.x = deslX * -1;
            //wheelFI.position.z = deslZ;
            wheelFO.rotation.x = 0.5;

            //wheelRI.position.y = deslY;
            //wheelRI.position.x = deslX;
            //wheelRI.position.z = deslZ * -1;
            wheelFO.rotation.x = 0.5;

            //wheelRO.position.y = deslY;
            //wheelRO.position.x = deslX * -1;
            //wheelRO.position.z = deslZ * -1;
            wheelFO.rotation.z = 0.5;
            //#endregion

            meshCarro.addChild(hitbox);
            meshCarro.addChild(caixaCorpoInferiorCarro);
            meshCarro.addChild(caixaCorpoMediaCarro );
            meshCarro.addChild(caixaCorpoSuperiorCarro);
            meshCarro.addChild(wheelFI);
            meshCarro.addChild(wheelFO);
            meshCarro.addChild(wheelRI);
            meshCarro.addChild(wheelRO);
            meshCarro.addChild(pivotFI);
            meshCarro.addChild(pivotFO);
            meshCarro.addChild(pivot);
            
            return meshCarro;
        }

        function criarEstrada() {

            var meshEstrada = new BABYLON.Mesh("estrada", scene);
            var corCinza = materialCor("cinza");

            let deslY = -2;
            let inicioZ = -10.05;

            var estrada = BABYLON.MeshBuilder.CreateBox("caixa", { height: 0.3, width: 14, size: 25.5 }, scene);
            estrada.position.y = deslY;
            estrada.material = corCinza;

            for (i = 0; i < 5; i++) {
                var risco = BABYLON.MeshBuilder.CreateBox("risco", { height: 0.6, width: 1.5, size: 4.5 }, scene);
                risco.position.z = inicioZ;
                risco.position.y = deslY;
                inicioZ = inicioZ + 5;

                meshEstrada.addChild(risco);
            }

            meshEstrada.addChild(estrada);

            return meshEstrada;
            }

            function materialCor( corParam ) {

            var cor = new BABYLON.StandardMaterial("cor", scene);

            if (corParam === "preto") {
                cor.diffuseColor = new BABYLON.Color3(0, 0, 0);
            } else if (corParam === "azul") {
                cor.diffuseColor = new BABYLON.Color3(0, 0, 1);
            } else if (corParam === "verde") {
                cor.diffuseColor = new BABYLON.Color3(0, 1, 0);
            } else if (corParam === "cinza") {
                cor.diffuseColor = new BABYLON.Color3(0.35, 0.35, .35);
            } else if (corParam === "amarelo") {
                cor.diffuseColor = new BABYLON.Color3(1, 0.35, 1);
            } else {
                cor.diffuseColor = new BABYLON.Color3(1, 1, 1);
            }

            return cor;
        }

            function materialCarro(materialParam){

            var material = new BABYLON.StandardMaterial("material", scene);

            if(materialParam == "1"){
                material.diffuseTexture = new BABYLON.Texture("./Vermelho.jpg");
                material.specularTexture = new BABYLON.Texture("./Vermelho.jpg");
                material.emissiveTexture = new BABYLON.Texture("./Vermelho.jpg");
            }else if(materialParam == "2"){
                material.diffuseTexture = new BABYLON.Texture("./Golden.jpg");
                material.specularTexture = new BABYLON.Texture("./Golden.jpg");
                material.emissiveTexture = new BABYLON.Texture("./Golden.jpg");
            }else if(materialParam == "3"){
                material.diffuseTexture = new BABYLON.Texture("./DM.jpg");
                material.specularTexture = new BABYLON.Texture("./DM.jpg");
                material.emissiveTexture = new BABYLON.Texture("./DM.jpg");
            }else if(materialParam == "4"){
                material.diffuseTexture = new BABYLON.Texture("./Space.jpg");
                material.specularTexture = new BABYLON.Texture("./Space.jpg");
                material.emissiveTexture = new BABYLON.Texture("./Space.jpg");
            }else if(materialParam == "5"){
                material.diffuseTexture = new BABYLON.Texture("./Ocean.jpg");
                material.specularTexture = new BABYLON.Texture("./Ocean.jpg");
                material.emissiveTexture = new BABYLON.Texture("./Ocean.jpg");
            }else{
                material.diffuseTexture = new BABYLON.Texture("./8b4569310eb53353c9190ae6efa7eb4c.jpg");
                material.specularTexture = new BABYLON.Texture("./8b4569310eb53353c9190ae6efa7eb4c.jpg");
                material.emissiveTexture = new BABYLON.Texture("./8b4569310eb53353c9190ae6efa7eb4c.jpg");
            }

            return material;
            }

            function criarHubMenuEscolha() {
            var advancedTexture;

            var buildUI = function () {
                if (advancedTexture) {
                    advancedTexture.dispose();
                }
                advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");

                var bottomPanel = new BABYLON.GUI.StackPanel();
                bottomPanel.height = "130px";
                bottomPanel.paddingBottom = "20px";
                bottomPanel.isVertical = true;
                bottomPanel.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_STRETCH;
                bottomPanel.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
                bottomPanel.fontSize = 20;
                advancedTexture.addControl(bottomPanel);

                var topPanel = new BABYLON.GUI.StackPanel();
                topPanel.height = "550px";
                topPanel.paddingBottom = "20px";
                topPanel.isVertical = true;
                topPanel.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_STRETCH;
                topPanel.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
                topPanel.fontSize = 16;
                advancedTexture.addControl(topPanel);

                var addHeader = function (text, panel, alinhamento) {
                    var header = new BABYLON.GUI.TextBlock();
                    header.text = text;
                    header.height = "30px";
                    header.color = "white";
                    header.outlineWidth = "4px";
                    header.outlineColor = "black";
                    header.textHorizontalAlignment = alinhamento;

                    panel.addControl(header);
                }

                var alinhamentoCentro = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;

                addHeader("AVALIAÇÃO FINAL", topPanel, alinhamentoCentro);
                addHeader("Gabriel Antonio Noel - 180274", topPanel, alinhamentoCentro);
                addHeader("Gustavo dos Santos Nogueira - 181010", topPanel, alinhamentoCentro);
                addHeader("Aperte H para verificar as configurações", topPanel, alinhamentoCentro);

                addHeader("SELECIONE O CARRO QUE DESEJA JOGAR", bottomPanel, alinhamentoCentro);
                addHeader("PARA SELECIONAR USE O CLIQUE", bottomPanel, alinhamentoCentro);
                addHeader("(OS CARROS REPRESENTAM O NÍVEL DE DIFICULDADE, SENDO DO MAIS FÁCIL AO DIFÍCIL, DA ESQUERDA A DIREITA)", bottomPanel, alinhamentoCentro);
            }

           


            buildUI();
            return advancedTexture;
        }

        function criarHubConfirmarCarro(scene) {
            let tamanhoOriginal;
            let tamanho;
            var meshBotoes = new BABYLON.Mesh("botoes", scene);
            scene.cameras.forEach(function(camera){
                camera.dispose(false,true)
            })

            var camera = new BABYLON.ArcRotateCamera("Camera", 0, 0, 0, BABYLON.Vector3.Zero(), scene);
            camera.setPosition(new BABYLON.Vector3(40, 10, 0));
            camera.lockedTarget = new BABYLON.Vector3(0,0,0);
            camera.attachControl(canvas,true);

            camera.inputs.remove(camera.inputs.attached.mousewheel);

            var bg = scene.getMeshesByID("bg");
            bg.forEach(function(mesh){
                mesh.dispose();
            })
            

            createSmoke();
            scene.clearColor = new BABYLON.Color3(0,0.5,1);
            tamanho = meshCarro.absoluteScaling.x;
            tamanho += 2;
            meshCarro.scaling = new BABYLON.Vector3(tamanho, tamanho, tamanho);

            var buildUI = function () {
                if (advancedTexture) {
                    advancedTexture.dispose();
                }
                advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");

                var bottomPanel = new BABYLON.GUI.StackPanel();
                bottomPanel.height = "100px";
                bottomPanel.paddingBottom = "20px";
                bottomPanel.isVertical = true;
                bottomPanel.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_STRETCH;
                bottomPanel.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
                bottomPanel.fontSize = 20;
                advancedTexture.addControl(bottomPanel);

                var topPanel = new BABYLON.GUI.StackPanel();
                topPanel.height = "600px";
                topPanel.paddingBottom = "20px";
                topPanel.isVertical = true;
                topPanel.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_STRETCH;
                topPanel.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
                topPanel.fontSize = 16;
                advancedTexture.addControl(topPanel);

                var addHeader = function (text, panel, alinhamento) {
                    var header = new BABYLON.GUI.TextBlock();
                    header.text = text;
                    header.height = "30px";
                    header.color = "white";
                    header.outlineWidth = "4px";
                    header.outlineColor = "black";
                    header.textHorizontalAlignment = alinhamento;

                    panel.addControl(header);
                }

                var alinhamentoCentro = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;

                addHeader("AVALIAÇÃO FINAL", topPanel, alinhamentoCentro);
                addHeader("Gabriel Antonio Noel - 180274", topPanel, alinhamentoCentro);
                addHeader("Gustavo dos Santos Nogueira - 181010", topPanel, alinhamentoCentro);
                addHeader("Aperte H para verificar as configurações", topPanel, alinhamentoCentro);

                addHeader("DESEJA ESCOLHER ESSE CARRO?", bottomPanel, alinhamentoCentro);

                //var advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("myUI");
                var botaoSim = BABYLON.GUI.Button.CreateSimpleButton("sim", "Sim");
                botaoSim.width = 0.1
                botaoSim.top = 280;
                botaoSim.left = 80;
                botaoSim.height = "40px"
                botaoSim.color = "white"
                botaoSim.background = "grey"
                advancedTexture.addControl(botaoSim);

                var botaoNao = BABYLON.GUI.Button.CreateSimpleButton("nao", "Não");
                botaoNao.width = 0.1
                botaoNao.top = 280;
                botaoNao.left = -80;
                botaoNao.height = "40px"
                botaoNao.color = "white"
                botaoNao.background = "grey"
                advancedTexture.addControl(botaoNao);

                var botaoAumentar = BABYLON.GUI.Button.CreateSimpleButton("aumentar", "Aumentar Zoom");
                botaoAumentar.width = 0.1
                botaoAumentar.top = -40;
                botaoAumentar.left = -600;
                botaoAumentar.height = "40px"
                botaoAumentar.color = "white"
                botaoAumentar.background = "blue"
                advancedTexture.addControl(botaoAumentar);

                var botaoDiminuir = BABYLON.GUI.Button.CreateSimpleButton("diminuir", "Diminuir Zoom");
                botaoDiminuir.width = 0.1
                botaoDiminuir.top = 20;
                botaoDiminuir.left = -600;
                botaoDiminuir.height = "40px"
                botaoDiminuir.color = "white"
                botaoDiminuir.background = "blue"
                advancedTexture.addControl(botaoDiminuir);


                botaoNao.onPointerClickObservable.add(function () {
                    meshCarro.dispose();
                    var menuText = menuEscolha(scene);
                    advancedTexture.dispose();
                    selecionado = false;
                    zoom = 0;
                    escolhaConfirmarCarro(menuText, scene);
                });

                botaoSim.onPointerClickObservable.add(function () {
                    scene.meshes.forEach(function (mesh){
                        mesh.dispose();
                    })
                    advancedTexture.dispose();
                    inGame = true;
                    createGameScene(scene,selectedCar);
                });

                if(zoom == 0){
                    tamanhoOriginal = meshCarro.absoluteScaling.x;
                }

                botaoDiminuir.onPointerClickObservable.add(function () {
                    tamanho = meshCarro.absoluteScaling.x;
                    if (zoom>-3) {
                        tamanho -= 0.5;
                        meshCarro.scaling = new BABYLON.Vector3(tamanho, tamanho, tamanho);
                        zoom--;
                    }
                });

                botaoAumentar.onPointerClickObservable.add(function () {
                    tamanho = meshCarro.absoluteScaling.x;
                    if (zoom<3) {
                        tamanho += 0.5;
                        meshCarro.scaling = new BABYLON.Vector3(tamanho, tamanho, tamanho);
                        zoom++;
                    }
                });
            }

            buildUI();
            return advancedTexture;
        }

        function criarHubInGame() {
            //var advancedTexture;

            var buildUI = function () {
                if (advancedTexture) {
                    advancedTexture.dispose();
                }
                advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");


                var topPanelE = new BABYLON.GUI.StackPanel();
                topPanelE.width = "350px";
                topPanelE.isVertical = true;
                topPanelE.paddingLeft = "20px";
                topPanelE.paddingTop = "10px";
                topPanelE.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
                topPanelE.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
                topPanelE.fontSize = 16;
                advancedTexture.addControl(topPanelE);

                var topPanelD = new BABYLON.GUI.StackPanel();
                topPanelD.width = "350px";
                topPanelD.isVertical = true;
                topPanelD.paddingLeft = "20px";
                topPanelD.paddingTop = "20px";
                topPanelD.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT;
                topPanelD.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
                topPanelD.fontSize = 20;
                advancedTexture.addControl(topPanelD);

                var addHeader = function (text, panel, alinhamento) {
                    var header = new BABYLON.GUI.TextBlock();
                    header.text = text;
                    header.height = "30px";
                    header.color = "white";
                    header.outlineWidth = "4px";
                    header.outlineColor = "black";
                    header.textHorizontalAlignment = alinhamento;

                    panel.addControl(header);
                }

                var alinhamentoCentro = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;

                addHeader("Aperte H para verificar as configurações", topPanelE, alinhamentoCentro);
                addHeader("(Caso aperter H, sairá da partida atual)", topPanelE, alinhamentoCentro);
                addHeader("PONTOS: "+points, topPanelD, alinhamentoCentro);      
            }

            buildUI();
            return advancedTexture;
        }

        function criarHubEnd() {
            //var advancedTexture;

            var buildUI = function () {
                if (advancedTexture) {
                    advancedTexture.dispose();
                }
                advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");

                var bottomPanel = new BABYLON.GUI.StackPanel();
                bottomPanel.height = "130px";
                bottomPanel.paddingBottom = "20px";
                bottomPanel.isVertical = true;
                bottomPanel.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_STRETCH;
                bottomPanel.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
                bottomPanel.fontSize = 20;
                advancedTexture.addControl(bottomPanel);

                var topPanel = new BABYLON.GUI.StackPanel();
                topPanel.height = "550px";
                topPanel.paddingBottom = "20px";
                topPanel.isVertical = true;
                topPanel.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_STRETCH;
                topPanel.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
                topPanel.fontSize = 18;
                advancedTexture.addControl(topPanel);

                var addHeader = function (text, panel, alinhamento) {
                    var header = new BABYLON.GUI.TextBlock();
                    header.text = text;
                    header.height = "30px";
                    header.color = "white";
                    header.outlineWidth = "4px";
                    header.outlineColor = "black";
                    header.textHorizontalAlignment = alinhamento;

                    panel.addControl(header);
                }

                var alinhamentoCentro = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;

                addHeader("AVALIAÇÃO FINAL", topPanel, alinhamentoCentro);
                addHeader("Gabriel Antonio Noel - 180274", topPanel, alinhamentoCentro);
                addHeader("Gustavo dos Santos Nogueira - 181010", topPanel, alinhamentoCentro);
                addHeader("Aperte H para verificar as configurações", topPanel, alinhamentoCentro);
                addHeader("", topPanel, alinhamentoCentro);
                addHeader("", topPanel, alinhamentoCentro);
                addHeader("", topPanel, alinhamentoCentro);
                addHeader("", topPanel, alinhamentoCentro);
                addHeader("CORRIDA FINALIZADA COM SUCESSO", topPanel, alinhamentoCentro);
                addHeader("PONTOS: "+points, topPanel, alinhamentoCentro); 
                addHeader("PARABÉNS!!!", topPanel, alinhamentoCentro);

                var botaoVoltar = BABYLON.GUI.Button.CreateSimpleButton("voltar", "Voltar ao menu principal");
                botaoVoltar.width = 0.2
                botaoVoltar.top = 160;
                botaoVoltar.left = 0;
                botaoVoltar.height = "50px"
                botaoVoltar.color = "white"
                botaoVoltar.background = "grey"
                advancedTexture.addControl(botaoVoltar);
                
                botaoVoltar.onPointerClickObservable.add(function () {
                    var menuText = menuEscolha(scene);
                    advancedTexture.dispose();
                    selecionado = false;
                    zoom = 0;
                    points = 0;
                    escolhaConfirmarCarro(menuText, scene);
                });
            }

            buildUI();
            return advancedTexture;
        }

        function criarHubHelp() {
            var advancedTexture;

            var buildUI = function () {
                if (advancedTexture) {
                    advancedTexture.dispose();
                }
                advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");

                var bottomPanel = new BABYLON.GUI.StackPanel();
                bottomPanel.height = "130px";
                bottomPanel.paddingBottom = "20px";
                bottomPanel.isVertical = true;
                bottomPanel.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_STRETCH;
                bottomPanel.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
                bottomPanel.fontSize = 20;
                advancedTexture.addControl(bottomPanel);

                var topPanel = new BABYLON.GUI.StackPanel();
                topPanel.height = "550px";
                topPanel.paddingBottom = "20px";
                topPanel.isVertical = true;
                topPanel.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_STRETCH;
                topPanel.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
                topPanel.fontSize = 18;
                advancedTexture.addControl(topPanel);

                var addHeader = function (text, panel, alinhamento) {
                    var header = new BABYLON.GUI.TextBlock();
                    header.text = text;
                    header.height = "30px";
                    header.color = "white";
                    header.outlineWidth = "4px";
                    header.outlineColor = "black";
                    header.textHorizontalAlignment = alinhamento;

                    panel.addControl(header);
                }

                var alinhamentoCentro = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;

                addHeader("AVALIAÇÃO FINAL", topPanel, alinhamentoCentro);
                addHeader("Gabriel Antonio Noel - 180274", topPanel, alinhamentoCentro);
                addHeader("Gustavo dos Santos Nogueira - 181010", topPanel, alinhamentoCentro);
                addHeader("Aperte H para verificar as configurações", topPanel, alinhamentoCentro);
                addHeader("", topPanel, alinhamentoCentro);
                addHeader("", topPanel, alinhamentoCentro);
                addHeader("", topPanel, alinhamentoCentro);
                addHeader("", topPanel, alinhamentoCentro);
                addHeader("Para jogar é necessário apenas selecionar o seu carro e capturar o máximo de pontos que irão aparecer no cenário antes de chegar ao fim da pista.", topPanel, alinhamentoCentro);
                addHeader("Os carros apresentam dificuldade diferentes, pois possuem velocidades diferentes.", topPanel, alinhamentoCentro); 
                addHeader("Os que estão mais a direita são mais rápidos se comparado aos que encontram na esquerda.", topPanel, alinhamentoCentro); 
                addHeader("A quantidade de pontos que existentes aumentam conforme a dificuldade.", topPanel, alinhamentoCentro); 
                addHeader("O jogador não pode controlar o carro, apenas capturar os pontos. Para capturar os pontos é necessário apenas clicar sobre eles.", topPanel, alinhamentoCentro);
                addHeader("", topPanel, alinhamentoCentro);
                addHeader("", topPanel, alinhamentoCentro);
                addHeader("", topPanel, alinhamentoCentro);
                addHeader("APERTE J PARA VOLTAR AO MENU DE ESCOLHA", topPanel, alinhamentoCentro);
            }

            buildUI();
            return advancedTexture;
        }

        function cleanMesh(scene){
            var meshes = scene.getMeshesByID("carro");
            meshes.forEach(function(mesh){
                mesh.dispose();
            })
            var ground = scene.getMeshesByID("ground");
            ground.forEach(function(mesh){
                mesh.dispose();
            })
        }

        function setupCarSelectScene(scene, objectFunction, carID){
            cleanMesh(scene);
            selecionado = true;
            scene.cameras.forEach(function(camera){
                camera.dispose(false,true)
            })

            const object = objectFunction(carID);

            var camera = new BABYLON.ArcRotateCamera("Camera", 0, 0, 0, BABYLON.Vector3.Zero(), scene);
            camera.setPosition(new BABYLON.Vector3(20, 5, 0));
            camera.attachControl(canvas, true);

            var light2 = new BABYLON.PointLight("light2", new BABYLON.Vector3(10, 3,0), scene);

            attachCamera(camera,object)
            return object;
        }

        function attachCamera(camera,object){
            camera.setTarget(object);
        }

        function escolhaClicarPonto(scene){
            scene.onPointerDown = function(event, pickResult) {
                if(pickResult.hit) {
                    if(pickResult.pickedMesh.id == "point"){
                        pickResult.pickedMesh.dispose();
                        points += 10;
                        if (advancedTexture) {
                            advancedTexture.dispose();
                        }
                        criarHubInGame(); 
                    }
                }  
            }
        }


        function escolhaConfirmarCarro(menuText, scene){
            scene.onPointerDown = function(event, pickResult) {
                if(pickResult.hit && !selecionado) {
                    if(pickResult.pickedMesh.id == 1){
                        const car = setupCarSelectScene(scene,criarCarro, 1);      
                        menuHelp.dispose();
                        const menu = criarHubConfirmarCarro(scene);
                        selectedCar = 1;
                    }
                    else if(pickResult.pickedMesh.id == 2){
                        const car = setupCarSelectScene(scene,criarCarro, 2);
                        menuHelp.dispose();
                        const menu = criarHubConfirmarCarro(scene);
                        selectedCar = 2;
                    }
                    else if(pickResult.pickedMesh.id == 3){
                        const car = setupCarSelectScene(scene,criarCarro, 3);
                        menuHelp.dispose();
                        const menu = criarHubConfirmarCarro(scene);
                        selectedCar = 3;
                    }
                    else if(pickResult.pickedMesh.id == 4){
                        const car = setupCarSelectScene(scene,criarCarro, 4);
                        menuHelp.dispose();
                        const menu = criarHubConfirmarCarro(scene);
                        selectedCar = 4;
                    }
                    else if(pickResult.pickedMesh.id == 5){
                        const car = setupCarSelectScene(scene,criarCarro, 5);
                        menuHelp.dispose();
                        const menu = criarHubConfirmarCarro(scene);
                        selectedCar = 5;
                    }
                    else if(pickResult.pickedMesh.id =="point"){
                        pickResult.pickedMesh.dispose();
                        points += 10;
                    }
                }
            }
        }


        function createGameScene(scene, idCarro) {
            idSelectedCar = idCarro;
            cleanMesh(scene);
            scene.cameras.forEach(function(camera){
                camera.dispose(false,true)
            })
            createSmoke();
            const txtHub = criarHubInGame();
            //scene.clearColor = new BABYLON.Color3(0,0.5,1);
            var groundSize = 3000;
  
            var ground = BABYLON.MeshBuilder.CreateGround("ground", {width: groundSize, height: groundSize}, scene);
            var groundMaterial = new BABYLON.StandardMaterial("ground", scene);
            groundMaterial.diffuseColor = new BABYLON.Color3(0, 0, 0);
            ground.material = groundMaterial;
            ground.position.y = -0.8;

            var groundTrack = BABYLON.MeshBuilder.CreateGround("ground", {width: 35, height: groundSize}, scene);
            var groundTrackMaterial = new BABYLON.StandardMaterial("ground", scene);
            groundTrackMaterial.diffuseColor = new BABYLON.Color3(0.1, 0.1, 0.1);
            groundTrack.material = groundTrackMaterial;
            groundTrack.position.y = -0.7;

            var groundFinal = BABYLON.MeshBuilder.CreateGround("ground", {width: 35, height: 10}, scene);
            var groundFinalMaterial = new BABYLON.StandardMaterial("ground", scene);
            groundFinalMaterial.diffuseTexture = new BABYLON.Texture("Final.jpg");
            groundFinalMaterial.specularTexture = new BABYLON.Texture("Final.jpg");
            groundFinalMaterial.emissiveTexture = new BABYLON.Texture("Final.jpg");
            groundFinal.material = groundFinalMaterial;
            groundFinal.position.y = -0.6;
            groundFinal.position.z = - 1040;

            scene.clearColor = new BABYLON.Color3(0,0,0);

            

            var car =criarCarro(idCarro);

            escolhaClicarPonto(scene);
            createBlocks(scene);
            //carroAndar(car, idCarro, points);

            /*car._children.forEach(function(carProp){
                if(carProp.id == "pivotFO")
            })*/
    


            var camera = new BABYLON.ArcRotateCamera("Camera", 0, 0, 0, BABYLON.Vector3.Zero(), scene);
            camera.setPosition(new BABYLON.Vector3(0, 7, 20));
            //camera.attachControl(canvas, true);

            var light2 = new BABYLON.PointLight("light2", new BABYLON.Vector3(100, 250, 0), scene);
            light2.diffuse= new BABYLON.Color3(0.9,0.9,0.9);
            light2.specular= new BABYLON.Color3(1,1,1);
           
            

            attachCamera(camera,car);
        }

        function createSmoke(){
            var particleSystem;
            var useGPUVersion = false;

            var fogTexture = new BABYLON.Texture("https://raw.githubusercontent.com/aWeirdo/Babylon.js/master/smoke_15.png", scene);

            var fountain = BABYLON.Mesh.CreateBox("foutain", .01, scene);
            fountain.visibility = 1;
            var createNewSystem = function () {
                if (particleSystem) {
                    particleSystem.dispose();
                }

                if (useGPUVersion && BABYLON.GPUParticleSystem.IsSupported) {
                    particleSystem = new BABYLON.GPUParticleSystem("particles", { capacity: 250000 }, scene);
                    particleSystem.activeParticleCount = 15000;
                    particleSystem.manualEmitCount = particleSystem.activeParticleCount;
                    particleSystem.minEmitBox = new BABYLON.Vector3(-50, -30, -1000);  // Starting all from
                    particleSystem.maxEmitBox = new BABYLON.Vector3(100, 50, 1000); // To..

                } else {
                    particleSystem = new BABYLON.ParticleSystem("particles", 10000, scene);
                    particleSystem.manualEmitCount = particleSystem.getCapacity();
                    particleSystem.minEmitBox = new BABYLON.Vector3(-50, -30, -1000); // Starting all from
                    particleSystem.maxEmitBox = new BABYLON.Vector3(100, 50, 1000); // To...
                }


                particleSystem.particleTexture = fogTexture.clone();
                particleSystem.emitter = fountain;

                particleSystem.color1 = new BABYLON.Color4(0.8, 0.8, 0.8, 0.1);
                particleSystem.color2 = new BABYLON.Color4(.95, .95, .95, 0.15);
                particleSystem.colorDead = new BABYLON.Color4(0.9, 0.9, 0.9, 0.1);
                particleSystem.minSize = 3.5;
                particleSystem.maxSize = 5.0;
                particleSystem.minLifeTime = Number.MAX_SAFE_INTEGER;
                particleSystem.emitRate = 50000;
                particleSystem.blendMode = BABYLON.ParticleSystem.BLENDMODE_STANDARD;
                particleSystem.gravity = new BABYLON.Vector3(0, 0, 0);
                particleSystem.direction1 = new BABYLON.Vector3(0, 0, 0);
                particleSystem.direction2 = new BABYLON.Vector3(0, 0, 0);
                particleSystem.minAngularSpeed = -2;
                particleSystem.maxAngularSpeed = 2;
                particleSystem.minEmitPower = .5;
                particleSystem.maxEmitPower = 1;
                particleSystem.updateSpeed = 0.005;

                particleSystem.start();
            }

            createNewSystem();

        }

        function createBlocks(scene){
            var materialRainbow = new BABYLON.StandardMaterial("rainbow", scene);
            materialRainbow.diffuseTexture = new BABYLON.Texture('Rainbow.jpg');
            materialRainbow.specularTexture = new BABYLON.Texture('Rainbow.jpg');
            materialRainbow.emissiveTexture = new BABYLON.Texture('Rainbow.jpg');

            for(let i =0 ; i< 300 ; i++){
                var box = BABYLON.MeshBuilder.CreateBox("point", {}, scene);
                box.position = new BABYLON.Vector3(-5 + Math.random()*10, 5, -1000 + Math.random()*1000);
                box.material = materialRainbow;
            }
        }

        /*function carroAndar(carro, idSelectedCar, velocidade){
            carro.position.z += velocidade*idSelectedCar + idSelectedCar*2;
        }*/

        function corridaFinalizada(scene){
            var pontos = scene.getMeshesByID("point");
            var smoke = scene.getMeshByID("foutain");
            var carro = scene.getMeshByID("carro");
            var plane = scene.getMeshesByID("ground");

            carro.dispose();
            smoke.dispose();

            plane.forEach(function (mesh){
                mesh.dispose();
            })


            pontos.forEach(function (mesh){
                mesh.dispose();
            })

            inGame = false;
            if (advancedTexture)
                advancedTexture.dispose();
            criarHubEnd();
            inGame = false;
        }

        function loop(scene) {

            if(inGame){
                var carro = scene.getMeshByID("carro");

                carro.position.z -= 0.4 + (points*idSelectedCar)/3000 - (idSelectedCar*0.4)/300;

                if(carro.position.z < -1050)
                    corridaFinalizada(scene);
            }else{
                var carros = scene.getMeshesByID("carro")
                carros.forEach(function (point){
                    point.rotation.y += 0.01;
                })
            }
        };

        engine = createDefaultEngine();
        if (!engine) throw 'engine should not be null.';
        scene = createScene();

        engine.runRenderLoop(function () {
            if (scene) {
                loop(scene);
                scene.render();
            }
        });

        // Resize
        window.addEventListener("resize", function () {
            engine.resize();
        });

        </script>
    </body>

</html>